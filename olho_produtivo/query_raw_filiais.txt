with base_mecs as(
  select 
    filial,
    id_funcionario_v2,
    lower(nome_funcionario) nome_funcionario
  from `man_operacao.jornada_de_trabalho` 
  where mec_na_folha and dia = current_date()-1 
)

,mecs_agrupados AS (
  SELECT
    filial,
    -- Criar um mapa com id_funcionario_v2 como chave e nome_funcionario como valor
    -- Isso permite acesso direto por ID sem percorrer a lista
    ARRAY_AGG(STRUCT(CAST(id_funcionario_v2 AS STRING) AS id, nome_funcionario AS nome)) AS mecs
  FROM base_mecs
  GROUP BY filial
)

select 
  cf.gerente_regional
  ,lugar
  ,lugarid
  ,mri.mec_rampa_ideal
  ,op.meta_internas
  ,ma.mecs
from `exp_atendimentos.cadastro_filiais` cf
left join `exp_frota.mecanicos_rampa_ideal` mri on mri.filial = cf.lugar
left join (select filial, count(*) as meta_internas from `exp_frota.ordem_de_producao_historico` where dia_ordem = current_date()-1 group by all) op on op.filial = cf.lugar
left join mecs_agrupados ma on cf.lugar = ma.filial 
where 
  cf.terceiro = 0 
  and cf.filial_ativa = 1 
  and cf.gerente_regional not in ("Jessica","Indefinido") 
  and lugar not in ("Mottu Butantã","Mottu São Mateus")
order by gerente_regional, lugarid